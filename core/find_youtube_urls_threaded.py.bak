#!/usr/bin/env python3
import subprocess
import json
from pathlib import Path
from rapidfuzz import fuzz
from multiprocessing.dummy import Pool as ThreadPool  # Thread-based pool

# -------------------
# CONFIG
# -------------------
MAX_THREADS = 8                 # Maximum threads to use
SEARCH_YOUTUBE = True           # Set True to search YouTube
SEARCH_SOUNDCLOUD = False       # Set True to search SoundCloud
OUTPUT_FILE = Path(__file__).parent / "found_urls.json"  # Automatic JSON save

# -------------------
# TRACK LIST
# -------------------
TRACKS = [
    "Rhythm Is Rhythm ‚Äì Icon (Transmat)",
    "Esser‚Äôay ‚Äì Forces ‚ÄòReese Mix‚Äô (KMS)",
    "E-Dancer ‚Äì Pump The Move (KMS)",
    "Outlander -The Vamp ‚ÄòKevin Saunderson Remix‚Äô (R&S)",
    "E-Dancer ‚Äì World of Deep (KMS)",
    "Slam ‚Äì Positive Education (Soma)",
    "Lemon 8 ‚Äì Model 8 ‚ÄòLemon 8 Remix‚Äô (Basic Energy)",
    "Robert Armani ‚Äì Circus Bells ‚ÄòRemixed By Hardfloor‚Äô (Djax -Up-Beats)",
    "FEOS vs M/S/O ‚Äì Into The Groove (Ongaku)",
    "Ian Pooley ‚Äì Chord Memory (Force Inc.)",
    "DJ Gilb-R ‚Äì Pressure ‚ÄòLaurentlaboratoiral'ancienne Mix‚Äô (Versatile)",
    "Dot Allison ‚Äì We‚Äôre Only Science ‚ÄòSlam Remix‚Äô (Mantra)",
    "Adam Beyer ‚Äì Remainings III ‚ÄòDK Remix 1‚Äô (Drumcode)",
    "Green Velvet ‚Äì Land Of The Lost ‚ÄòIan Pooley‚Äôs Infected Mix‚Äô (Music Man)",
    "Black Water ‚Äì Black Water (430 Wes)"
]

# -------------------
# SEARCH FUNCTIONS
# -------------------
def search_youtube(track_name):
    """Return the direct URL of the best matching YouTube video."""
    try:
        cmd = [
            "yt-dlp",
            f"ytsearch20:{track_name}",  # Top 20 results
            "--dump-json",
            "--skip-download"
        ]
        result = subprocess.run(cmd, capture_output=True, text=True)
        lines = result.stdout.strip().splitlines()
        best_score = -1
        best_url = None
        for line in lines:
            try:
                data = json.loads(line)
                title = data.get("title", "")
                url = data.get("webpage_url", "")
                score = fuzz.ratio(track_name.lower(), title.lower())
                if score > best_score:
                    best_score = score
                    best_url = url
            except Exception:
                continue
        return best_url or "‚ùå Not found"
    except Exception as e:
        return f"‚ùå Error: {e}"

def search_soundcloud(track_name):
    """Return the first SoundCloud track URL that matches the track name."""
    try:
        cmd = [
            "yt-dlp",
            f"scsearch5:{track_name}",  # Top 5 results
            "--dump-json",
            "--skip-download"
        ]
        result = subprocess.run(cmd, capture_output=True, text=True)
        lines = result.stdout.strip().splitlines()
        for line in lines:
            try:
                data = json.loads(line)
                url = data.get("webpage_url")
                if url:
                    return url
            except Exception:
                continue
        return "‚ùå Not found"
    except Exception as e:
        return f"‚ùå Error: {e}"

def worker(track):
    result = {"track": track}
    if SEARCH_YOUTUBE:
        result["youtube_url"] = search_youtube(track)
    if SEARCH_SOUNDCLOUD:
        result["soundcloud_url"] = search_soundcloud(track)
    return result

# -------------------
# THREADING & SAVE
# -------------------
if __name__ == "__main__":
    pool = ThreadPool(min(MAX_THREADS, len(TRACKS)))
    results = pool.map(worker, TRACKS)
    pool.close()
    pool.join()

    # Print results
    print("\nüéµ URL Results:\n")
    for r in results:
        line = r["track"]
        if SEARCH_YOUTUBE:
            line += f" -> YouTube: {r.get('youtube_url','‚ùå')}"
        if SEARCH_SOUNDCLOUD:
            line += f" -> SoundCloud: {r.get('soundcloud_url','‚ùå')}"
        print(line)

    # Automatically save JSON
    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        json.dump(results, f, indent=2, ensure_ascii=False)
    print(f"\n‚úÖ Results automatically saved to {OUTPUT_FILE}")
