import os
import argparse
import time
from core import pipeline  # restored pipeline.py
from core import scrape_soundcloud  # standalone SoundCloud scraper
from config import CONFIG

# -------------------------
# QUEUE & TOGGLES
# -------------------------
QUEUE_LIST = []
TOGGLE_KEYS = [
    "enable_youtube", "enable_soundcloud", "enable_duckduckgo",
    "restriction_checks", "copyright_checks", "analysis_only",
    "allow_downloads", "allow_js", "js_runtime_ready",
    "enable_js", "max_results", "download_dir"
]
VERBOSE_MODE = False
LOG_FILE = "/tmp/musicdowlder_verbose.log"

# -------------------------
# Helper functions
# -------------------------
def log_verbose(msg):
    if VERBOSE_MODE:
        timestamp = time.strftime("[%Y-%m-%d %H:%M:%S]")
        line = f"{timestamp} {msg}"
        print(line)
        with open(LOG_FILE, "a") as f:
            f.write(line + "\n")


def display_toggles():
    print("\nðŸ”˜ Current Toggles:")
    for i, key in enumerate(TOGGLE_KEYS, 1):
        value = CONFIG.get(key, None)
        print(f"{i}. {key}: {value}")


def toggle_option(number):
    if 1 <= number <= len(TOGGLE_KEYS):
        key = TOGGLE_KEYS[number - 1]
        value = CONFIG[key]
        if isinstance(value, bool):
            CONFIG[key] = not value
        elif isinstance(value, int):
            try:
                new_val = int(input(f"Enter new value for {key} (current: {value}): "))
                CONFIG[key] = new_val
            except ValueError:
                print("Invalid input, must be an integer")
        elif isinstance(value, str):
            new_val = input(f"Enter new value for {key} (current: {value}): ")
            CONFIG[key] = new_val
        print(f"{key} set to {CONFIG[key]}")


def display_queue():
    if not QUEUE_LIST:
        print("\nðŸ“­ Queue is empty")
    else:
        print("\nðŸŽµ Current Queue:")
        for idx, item in enumerate(QUEUE_LIST, 1):
            print(f"{idx}) {item['title']} ({item.get('source','unknown')})")


# -------------------------
# SoundCloud handler (auto add to queue)
# -------------------------
def handle_soundcloud(url):
    log_verbose(f"Detected SoundCloud URL: {url}")
    tracks = scrape_soundcloud.scrape_playlist(url)
    if tracks:
        QUEUE_LIST.extend(tracks)
        log_verbose(f"Added {len(tracks)} tracks from SoundCloud to the queue")
        display_queue()
        sc_json = scrape_soundcloud.get_playlist_file_path()
        if os.path.exists(sc_json):
            os.remove(sc_json)
            log_verbose(f"Removed temporary file {sc_json}")
    else:
        print("âŒ No SoundCloud tracks found.")


# -------------------------
# Add to queue from search
# -------------------------
def add_to_queue_from_search(results):
    print("\nSearch Results:")
    for idx, r in enumerate(results, 1):
        print(f"{idx}) {r['title']} ({r['source']})")
    sel = input("\nSelect numbers (e.g., 1,3-5) or ENTER to skip: ").strip()
    if not sel:
        return
    indexes = []
    for part in sel.split(","):
        part = part.strip()
        if '-' in part:
            try:
                start, end = map(int, part.split('-'))
                indexes.extend(range(start-1, end))
            except:
                pass
        elif part.isdigit():
            i = int(part)
            indexes.append(i-1)
    for i in indexes:
        if 0 <= i < len(results):
            QUEUE_LIST.append(results[i])
            print(f"Added to queue: {results[i]['title']}")


# -------------------------
# Main CLI loop
# -------------------------
def main_loop():
    global VERBOSE_MODE
    parser = argparse.ArgumentParser()
    parser.add_argument("-verbos", action="store_true", help="Enable verbose logging")
    args = parser.parse_args()
    VERBOSE_MODE = args.verbos
    if VERBOSE_MODE:
        open(LOG_FILE, "w").close()
    log_verbose("ðŸŽµ MusicDowlder App Started (verbose mode)")

    while True:
        display_toggles()
        display_queue()
        try:
            choice = input("\nEnter URL, number to toggle, or 'exit': ").strip()
        except KeyboardInterrupt:
            print("\nExiting...")
            break

        if choice.lower() == "exit":
            break

        if choice.isdigit():
            toggle_option(int(choice))
            continue

        url = choice
        if "soundcloud.com" in url:
            handle_soundcloud(url)
        else:
            results = pipeline.acquire(url)
            if not results or results[0].get("url") is None:
                print("âŒ No results found.")
            else:
                add_to_queue_from_search(results)


# -------------------------
# Run if executed directly
# -------------------------
if __name__ == "__main__":
    main_loop()
