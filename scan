# 1️⃣ Backup current script first
cp ~/musicdowlder/backup/list_large_dirs.py ~/musicdowlder/backup/list_large_dirs.py.bak

# 2️⃣ Overwrite with patched version
cat > ~/musicdowlder/backup/list_large_dirs.py << 'EOF'
#!/usr/bin/env python3
import os
from pathlib import Path
from time import sleep

ROOT_DIR = Path("/")  # Scan entire filesystem
SIZE_THRESHOLD = 5 * 1024**3  # 5 GB
TOP_N = 10  # Only show top 10 largest folders

def get_dir_size(path: Path) -> int:
    total = 0
    try:
        for root, dirs, files in os.walk(path, onerror=lambda e: None):
            for f in files:
                try:
                    fp = Path(root) / f
                    total += fp.stat().st_size
                except (PermissionError, FileNotFoundError):
                    continue
    except (PermissionError, FileNotFoundError):
        pass
    return total

def format_size(size_bytes):
    for unit in ['B','KB','MB','GB','TB']:
        if size_bytes < 1024:
            return f"{size_bytes:.2f} {unit}"
        size_bytes /= 1024
    return f"{size_bytes:.2f} PB"

def print_progress(current, total, prefix="", suffix="", length=40):
    if total == 0:
        percent = 0
    else:
        percent = current / total
    filled_len = int(length * percent)
    bar = '█' * filled_len + '-' * (length - filled_len)
    print(f'\r{prefix} |{bar}| {percent*100:.1f}% {suffix}', end='\r')

def main():
    folders = [f for f in ROOT_DIR.iterdir() if f.is_dir()]
    folder_sizes = []
    total_folders = len(folders)
    scanned_size = 0

    print(f"Scanning {ROOT_DIR} ...\n(This may take a while on large filesystems)\n")
    for i, item in enumerate(folders, 1):
        try:
            size = get_dir_size(item)
            scanned_size += size
            folder_sizes.append((item, size))
        except (PermissionError, FileNotFoundError):
            print(f"⚠️ Skipping restricted folder: {item}")
        print_progress(i, total_folders, prefix="Scanning", suffix=f"Total scanned: {format_size(scanned_size)}")

    print("\n\n✅ Scan complete.\n")
    # Sort by size descending and show top N
    folder_sizes.sort(key=lambda x: x[1], reverse=True)
    print(f"Top {TOP_N} largest folders (≥ {format_size(SIZE_THRESHOLD)}):")
    count = 0
    for folder, size in folder_sizes:
        if size >= SIZE_THRESHOLD:
            print(f"{folder} → {format_size(size)}")
            count += 1
            if count >= TOP_N:
                break

if __name__ == "__main__":
    main()
EOF

# 3️⃣ Make script executable
chmod +x ~/musicdowlder/backup/list_large_dirs.py

# 4️⃣ Run the patched script
python ~/musicdowlder/backup/list_large_dirs.py
