#!/usr/bin/env python3
import os
import sys
import threading
import time
from core import pipeline

VERBOSE = '-verbos' in sys.argv
VERBOSE_LOG_FILE = os.path.expanduser('~/musicdowlder/core/verbos.log')

# ---------------------------
# Verbose logging helper
# ---------------------------
def vprint(msg):
    if VERBOSE:
        timestamp = time.strftime("[%Y-%m-%d %H:%M:%S]")
        full_msg = f"{timestamp} {msg}"
        print(full_msg)
        with open(VERBOSE_LOG_FILE, 'a') as f:
            f.write(full_msg + "\n")

# ---------------------------
# SoundCloud playlist fetch
# ---------------------------
def fetch_soundcloud_playlist(url):
    vprint(f"üéß Detected SoundCloud playlist URL: {url}")
    import json
    import subprocess
    sc_json_file = os.path.expanduser('~/musicdowlder/core/soundcloud_playlist.json')
    cmd = [
        "python3", os.path.expanduser('~/musicdowlder/core/scrape_soundcloud.py')
    ]
    vprint(f"üõ† Running: {' '.join(cmd)}")
    subprocess.run(cmd)
    # Load JSON output
    with open(sc_json_file, 'r') as f:
        playlist = json.load(f)
    os.remove(sc_json_file)  # remove after reading
    vprint(f"‚úÖ Loaded {len(playlist)} tracks from SoundCloud playlist")
    return playlist

# ---------------------------
# Main interactive loop
# ---------------------------
def main():
    vprint("üéµ MusicDowlder App Started" + (" (verbose mode)" if VERBOSE else ""))
    while True:
        try:
            url = input("Enter URL (or 'exit' to quit): ").strip()
        except KeyboardInterrupt:
            print("\nExiting.")
            break
        if url.lower() == 'exit':
            break
        if not url:
            continue

        # Detect SoundCloud playlist
        if "soundcloud.com" in url and "/sets/" in url:
            try:
                queue_list = fetch_soundcloud_playlist(url)
            except Exception as e:
                print(f"‚ùå Failed to fetch SoundCloud playlist: {e}")
                continue
        else:
            # Normal search via pipeline.acquire
            vprint(f"üîç Searching for: {url}")
            queue_list = pipeline.acquire(url)
        
        # Show results
        vprint(f"üìã {len(queue_list)} items added to queue")
        print("Queue:")
        for i, track in enumerate(queue_list, 1):
            print(f"{i}) {track.get('title')} ({track.get('url')})")

        # Start download
        print("Starting download...")
        pipeline.download_multi(queue_list, max_threads=4)
        vprint("‚úÖ Finished processing queue")

if __name__ == "__main__":
    main()
